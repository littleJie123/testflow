<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试用例详情</title>
  <link rel="stylesheet" href="css/index.css">
</head>
<script src="js/http.js"></script>
<script src="js/util.js"></script>

<body>
  <div class="header">
    <h1 id="pageTitle">测试用例详情</h1>
  </div>
  <div id="statusDiv">状态</div>
  <div class="toolbar" id="toolbar">
    <button class="btn" onclick="runTestCase()">运行测试</button>
    <button class="btn" onclick="jumpToError()">跳到出错</button>
  </div>

  <div class="detail">

    <div class="actions-panel">
      <h2>测试步骤</h2>
      <div id="actionsList"></div>
    </div>
    <div class="logs-panel">
      <h2>测试日志</h2>
      <div id="logsList"></div>
    </div>
  </div>

  <div class="toolbar" id="bottomToolbar" style="display: none; margin-top: 1rem;">
    <button class="btn" onclick="runTestCase()">运行测试</button>
    <button class="btn" onclick="jumpToError()">跳到出错</button>
  </div>

  <div id="stepModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="modal-content-body"></div>
    </div>
  </div>

  <script>
    let http = Http.get();
    let testCaseId = '';
    const urlParams = new URLSearchParams(window.location.search);
    testCaseId = urlParams.get('id');
    const stepModal = document.getElementById("stepModal");
    const modalContent = stepModal.querySelector(".modal-content-body");
    const closeBtn = document.querySelector(".close");
    const stepData = {};

    // WebSocket connection

    http.on('httpParam', function (msg) {
      stepData[msg.id] = msg;
    });

    http.on('runStatus', function (msg) {
      const stepElement = document.getElementById(msg.id);
      if (stepElement) {
        stepElement.classList.remove('processed', 'error', 'running', 'init', 'runing');
        let status = msg.status;
        if(status === 'runing'){
            status = 'running';
        }
        stepElement.classList.add(status);
        const statusTxt = stepElement.querySelector('.statusTxt');
        if (statusTxt) {
          statusTxt.textContent = '状态: ' + getStatusText(msg.status);
        }
      }
    });

   



    function showStepDetails(stepId) {
      const data = stepData[stepId];
      const stepElement = document.getElementById(stepId);
      let status = '未知';
      if (stepElement) {
        const statusClass = Array.from(stepElement.classList).find(c => ['init', 'running', 'processed', 'error'].includes(c));
        if (statusClass) {
          status = getStatusText(statusClass);
        }
      }

      if (data) {
        modalContent.innerHTML = `
                <div class="modal-header">
                    <button class="btn" onclick="rerunAction('${stepId}')">重新运行</button>
                </div>
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>URL:</strong> <span id="modal-url">${data.url}</span></p>
                <p><strong>Method:</strong> <span id="modal-method">${data.method}</span></p>
                <p><strong>Headers:</strong></p>
                <pre id="modal-headers" contenteditable="true"></pre>
                <p><strong>Params:</strong></p>
                <pre id="modal-params" contenteditable="true"></pre>
                <p>
                    <strong>Result:</strong>
                    <button class="btn" onclick="copyResult()">copy result</button>
                </p>
                <pre id="modal-result"></pre>
            `;
        document.getElementById('modal-headers').innerHTML = Util.highlightJson(data.headers);
        document.getElementById('modal-params').innerHTML = Util.highlightJson(data.param);
        document.getElementById('modal-result').innerHTML = Util.highlightJson(data.result);
        stepModal.style.display = "block";
      } else {
        modalContent.innerHTML = `<p>No data available for this step.</p>`;
        stepModal.style.display = "block";
      }
    }

    function copyResult() {
      const resultText = document.getElementById('modal-result').innerText;
      navigator.clipboard.writeText(resultText).then(() => {
        alert('Result copied to clipboard!');
      }, () => {
        alert('Failed to copy result to clipboard.');
      });
    }

    async function rerunAction(actionId) {
      const headersText = document.getElementById('modal-headers').innerText;
      const paramsText = document.getElementById('modal-params').innerText;
      const url = document.getElementById('modal-url').innerText;
      const method = document.getElementById('modal-method').innerText;
      const resultPre = document.getElementById('modal-result');

      try {
        const headers = JSON.parse(headersText);
        const param = JSON.parse(paramsText);

        const result = await http.post('/runHttp', {
          url: url,
          method: method,
          headers: headers,
          param: param
        });

        resultPre.innerHTML = Util.highlightJson(result);

        // Blink effect
        let count = 0;
        const interval = setInterval(() => {
          resultPre.style.backgroundColor = count % 2 === 0 ? '#fff3cd' : '#f8f9fa';
          count++;
          if (count > 5) {
            clearInterval(interval);
            resultPre.style.backgroundColor = '#f8f9fa';
          }
        }, 200);

      } catch (error) {
        alert('Headers 或 Params 不是有效的 JSON 格式，请检查后重试。\n' + error);
      }
    }

    function scrollToLog(stepId) {
      const logEntries = document.querySelectorAll(`.log-item[data-step-id="${stepId}"]`);
      if (logEntries.length > 0) {
        // Remove highlight from previously highlighted logs
        document.querySelectorAll('.highlighted-log').forEach(el => el.classList.remove('highlighted-log'));

        logEntries.forEach(entry => entry.classList.add('highlighted-log'));
        logEntries[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }



    closeBtn.onclick = function () {
      stepModal.style.display = "none";
    }
    window.onclick = function (event) {
      if (event.target == stepModal) {
        stepModal.style.display = "none";
      }
    }



    // 页面加载时获取URL参数并初始化
    window.onload = function () {

      document.getElementById('pageTitle').textContent = `测试用例：${testCaseId}`;
      fetchTestCaseData();
    }

    // 获取测试用例数据
    async function fetchTestCaseData() {
      try {
        if (testCaseId == null) {
          return;
        }
        const data = await http.post(`/getTestCase`, { id: testCaseId });
        document.getElementById('pageTitle').textContent = data.name + `[ ${testCaseId} ]`;
        document.title = data.name;
        renderActions(data.actions || []);

      } catch (error) {
        console.error('获取测试用例数据失败:', error);
      }
    }

    function buildLookDetailBtn(action) {
      if (action.couldLookDetail) {
        return `<button class="btn" onclick="showStepDetails('${action.id}')">查看</button>`
      } else {
        return ''
      }
    }
    // 渲染测试步骤
    function renderActions(actions) {
      const actionsList = document.getElementById('actionsList');
      actionsList.innerHTML = actions.map((action, index) => `
                <div class="action-item ${action.status}" id="${action.id}">
                    <div class="action-info">
                        <h3>${index}. ${action.name}</h3>
                        <div class="statusTxt">状态: ${getStatusText(action.status)}</div>
                    </div>
                    <div class="action-buttons">
                        ${buildLookDetailBtn(action)}
                        <button class="btn" onclick="scrollToLog('${action.id}')">日志</button>
                        <button class="btn" onclick=runTestCase(${index})>运行</button>
                    </div>
                </div>
            `).join('');
      
      const bottomToolbar = document.getElementById('bottomToolbar');
      if (actions.length > 16) {
        bottomToolbar.style.display = 'flex';
      } else {
        bottomToolbar.style.display = 'none';
      }
      adjustLogPanelHeight();
    }

    

    function scrollToStep(stepId) {
        const stepElement = document.getElementById(stepId);
        if (stepElement) {
            stepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            let blinkCount = 0;
            const maxBlinks = 6; // 3 flashes (on/off is one flash, so 3*2=6)
            const blinkInterval = setInterval(() => {
                stepElement.classList.toggle('step-highlight');
                blinkCount++;
                if (blinkCount >= maxBlinks) {
                    clearInterval(blinkInterval);
                    // Ensure the class is removed at the end
                    stepElement.classList.remove('step-highlight');
                }
            }, 300); // Blink every 300ms
        }
    }

    // 切换堆栈信息显示
    function toggleStack(element) {
      if (element.querySelector('.log-stack')) {
        element.classList.toggle('expanded');
      }
    }

    // 获取状态文本
    function getStatusText(status) {
      const statusMap = {
        init: '初始化',
        running: '运行中',
        runing: '运行中',
        processed: '成功',
        error: '失败'
      };
      return statusMap[status] || status;
    }

    function jumpToError() {
      const errorStep = document.querySelector('.action-item.error');
      if (errorStep) {
        errorStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        alert('没有发现错误的步骤');
      }
    }

    // 运行测试用例
    async function runTestCase(index) {
      try {
        const actionItems = document.querySelectorAll('.action-item');
        actionItems.forEach(item => {
          item.classList.remove('processed', 'error', 'running', 'init');
          item.classList.add('init');
          const statusTxt = item.querySelector('.statusTxt');
          if (statusTxt) {
            statusTxt.textContent = '状态: 初始化';
          }
        });

        Util.initStatus();
        const logsList = document.getElementById('logsList');
        if (logsList) {
          logsList.innerHTML = ''; // 清空日志列表
        }
        let httpParam = { id: [testCaseId] };
        if(index != null){
          httpParam.index = index;
        }
        await http.post('/runTestCase', httpParam);


      } catch (error) {
        console.error('运行测试用例失败:', error);
      }
    }

    function adjustLogPanelHeight() {
      const actionsPanel = document.querySelector('.actions-panel');
      const logsPanel = document.querySelector('.logs-panel');
      const windowHeight = window.innerHeight;
      const actionsHeight = actionsPanel.offsetHeight;

      if (actionsHeight > windowHeight) {
        logsPanel.style.height = `${actionsHeight}px`;
      } else {
        logsPanel.style.height = `${windowHeight}px`;
      }
    }

    window.addEventListener('resize', adjustLogPanelHeight);

    // MutationObserver to watch for changes in the actions list
    const observer = new MutationObserver(adjustLogPanelHeight);
    observer.observe(document.getElementById('actionsList'), { childList: true, subtree: true });
  </script>
</body>

</html>